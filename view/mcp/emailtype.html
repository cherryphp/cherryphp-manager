<h1 class="page-header">邮件类型设置</h1>
<div class="table-responsive">
	<p>
		<!--<button class="btn btn-sm btn-default hide" type="button">Default</button>-->
		<?php if (in_array($rules_kv['邮件类型设置-添加'],$rules)){ ?><button class="btn btn-sm btn-primary" type="button" id="B_add">添加</button><?php } ?>
		<!--<button class="btn btn-sm btn-success hide" type="button">Success</button>-->
		<!--<button class="btn btn-sm btn-info hide" type="button">Info</button>-->
		<!--<button class="btn btn-sm btn-warning" type="button" id="B_update">修改</button>-->
		<!--<button class="btn btn-sm btn-danger" type="button" id="B_del">删除</button>-->
		<!--<button class="btn btn-sm btn-link hide" type="button">Link</button>-->
    </p>
	<div class="hide" id="alert_all" role="alert">
	</div>
	<table class="table table-striped table-hover" style="background-color:#cccccc;">
    <thead>
    <tr>
	  <th>类型ID</th>
      <th>类型名称</th>
	  <th>操作</th>
    </tr>
    </thead>
    <tbody id="rules_data">
		<tr>
			<td>#@id@#</td>
			<td>#@name@#</td>
			<td>编辑</td>
		</tr>
    </tbody>
	</table>
</div>

<!--<nav class="text-left">
	<ul class="pagination" id="pageui">
		<li class="page-number disabled"><a href="javascript:void(0)"><<</a></li>
		<li class="page-number disabled" ><a href="javascript:void(0)"><</a></li>
		<li class="page-number active"><a href="javascript:void(0)">1</a></li>
		<li class="page-number"><a href="javascript:void(0)">2</a></li>
		<li class="page-number"><a href="javascript:void(0)">3</a></li>
		<li class="page-number"><a href="javascript:void(0)">4</a></li>
		<li class="page-number"><a href="javascript:void(0)">5</a></li>
		<li class="page-number"><a href="javascript:void(0)">></a></li>
		<li class="page-number"><a href="javascript:void(0)">>></a></li>
	</ul>
</nav>-->
<!-- Modal-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel"></h4>
			</div>
			<div class="modal-body" id="myModalBody">
				11111
			</div>
			<div class="modal-footer">
				<button type="button" id="cancel" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" id="do" class="btn btn-primary">Save</button>
			</div>
		</div>
	</div>
</div>

			
<script>
$('#B_add').click(function(){
	if (typeof(inputcount)=="undefined"){
		inputcount=0;
	}
	inputcount++;
	var html=document.getElementById('rules_data').innerHTML;
	html+="<tr><td><input type='text' id='id_"+inputcount+"' value='' ></td><td><input type='text' id='value1_"+inputcount+"' value='' ></td><td><a href='#' onclick='javascript:saveC("+inputcount+",this);'>保存</a> | <a href='#' onclick='javascript:removeC(this);'>删除</a></td></tr>";
	document.getElementById('rules_data').innerHTML=html;
});

function saveC(ids,elm){
	var new_key=document.getElementById('id_'+ids).value;
	var new_value1=document.getElementById('value1_'+ids).value;
	if (new_key=="" || new_value1==""){
		alert("数据不能为空！");
		return ;
	}
	jsonvalue[new_key]=new_value1;
	savedata();
	createHTML();
}
function removeC(elm){
	document.getElementById('rules_data').removeChild(elm.parentNode.parentNode);
}
function removedata(key){
	delete jsonvalue[key];
	savedata();
	createHTML();
}
function editthis(key,td){
	td.parentNode.innerHTML='<?php if (in_array($rules_kv['邮件类型设置-修改'],$rules)){ ?><a href="#"  onclick="save(\''+key+'\',this);">保存</a> | <?php } ?><?php if (in_array($rules_kv['邮件类型设置-删除'],$rules)){ ?><a href="#" onclick="javascript:removedata(\''+key+'\');">删除</a><?php } ?>';
	var alltr=document.getElementsByTagName('tr');
	for (var i=0;i<alltr.length;i++){
		if (typeof(alltr[i].getElementsByTagName("td")[0])!=="undefined" && key==alltr[i].getElementsByTagName("td")[0].innerHTML){
			alltr[i].getElementsByTagName("td")[0].innerHTML="<input type='text' id='id_"+key+"' value='"+key+"' >";
		}
		if (typeof(alltr[i].getElementsByTagName("td")[1])!=="undefined" && jsonvalue[key]==alltr[i].getElementsByTagName("td")[1].innerHTML){
			alltr[i].getElementsByTagName("td")[1].innerHTML="<input type='text' id='value1_"+key+"' value='"+jsonvalue[key]+"' >";
		}
	}
}
function save(key,td){
	delete jsonvalue[key];
	
	var new_key=document.getElementById('id_'+key).value;
	var new_value1=document.getElementById('value1_'+key).value;
	jsonvalue[new_key]=new_value1;
	document.getElementById('id_'+key).parentNode.innerHTML=new_key;
	document.getElementById('value1_'+key).parentNode.innerHTML=new_value1;
	td.parentNode.innerHTML='<?php if (in_array($rules_kv['邮件类型设置-修改'],$rules)){ ?><a href="#"  onclick="editthis(\''+new_key+'\',this);">编辑</a><?php } ?>';
	savedata();
}

function savedata(){
	$.ajax({
		type: "POST",
		url: "/dataset/set_emailtype",
		data: {"jsondata":JSON.stringify(jsonvalue)},
		dataType: "json",
		success: function(res){
			var json=eval(res);
			if (json.stats==1){
				$('#alert_all').html("保存成功！");
				$('#alert_all').removeClass().addClass("alert alert-success alert-dismissible");
			}else{
				$('#alert_all').html("保存失败！");
				$('#alert_all').removeClass().addClass("alert alert-danger alert-dismissible");
			}
		}
	});
}

function createHTML(){
	var html='';
	for (i in jsonvalue){
		html+='<tr>';
		html+='<td>'+i+'</td>';
		html+='<td>'+jsonvalue[i]+'</td>';
		html+='<td><?php if (in_array($rules_kv['邮件类型设置-修改'],$rules) || in_array($rules_kv['邮件类型设置-删除'],$rules)){ ?><a href="#"  onclick="editthis(\''+i+'\',this);">编辑</a><?php } ?></td>';
		html+='</tr>';
	}
	$("#rules_data").html(html);
}

$.ajax({
	type: "POST",
	url: "/dataset/get_emailtype",
	data: {"a":0},
	dataType: "json",
	async:false,
	success: function(res){
		result=eval(res);
		jsonvalue=$.parseJSON(result.data[0].jsondata);
		createHTML();
	}
});
</script>